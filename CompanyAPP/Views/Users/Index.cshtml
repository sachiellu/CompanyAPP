@model List<CompanyAPP.Models.UserRolesViewModel>

@{
    ViewData["Title"] = "帳號管理";
}

@{
    // 最高權限名單(白名單)
    var superAdmins = new List<string>
    {
        "abccmick@gmail.com",
        "admin@default.com",
    };
}

<div class="container mt-4">
    <h2> 系統帳號與權限管理</h2>

    @*一次性開啟跳過舊帳號驗證按鈕 *@
    <form asp-action="FixOldUsers" method="post" onsubmit="return confirm('確定要執行「跳過驗證」嗎？這將會讓目前所有未驗證的帳號變成已驗證。');">
        <button type="submit" class="btn btn-warning shadow-sm">
            ⚡ 開通所有舊帳號 (Fix Data)
        </button>
    </form>
</div>

@* 顯示執行結果 *@
@if (TempData["StatusMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["StatusMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

    <div class="card shadow-sm mt-3">
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>帳號 (Email)</th>
                        <th>驗證狀態</th>
                        <th>目前身分 (Roles)</th>
                        <th class="text-center">操作</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Model)
                    {
                        <tr>
                            <td>@user.Email</td>

                        @*  綠色=已驗證 / 紅色=未驗證 *@
                        <td>
                            @if (user.EmailConfirmed)
                            {
                                <span class="badge bg-success">已驗證</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">未驗證</span>
                            }
                        </td>

                        <td>
                            @if (user.Roles.Contains("Admin"))
                            {
                                <span class="badge bg-danger">管理員</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">一般用戶</span>
                            }
                        </td>

                        <td class="text-center">
                                <div class="btn-group">

                                @* 檢查是否為超最高權限管理員 *@
                                @if (superAdmins.Contains(user.Email))
                                    {
                                    <span class="badge bg-secondary fst-italic">由系統保護</span>
                                    }

                                    else
                                    {
                                        <a asp-action="ManageRoles" asp-route-userId="@user.UserId" class="btn btn-outline-primary btn-sm">
                                            🔑 分配權限
                                        </a>

                                        @* 保護機制,用戶不能刪除自己 *@
                                        @if (User.Identity.Name != user.Email)
                                        {
                                            <a asp-action="Delete" asp-route-id="@user.UserId"
                                            class="btn btn-outline-danger btn-sm"
                                            onclick="return confirm('確定要刪除此帳號？');">刪除</a>
                                        }
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>