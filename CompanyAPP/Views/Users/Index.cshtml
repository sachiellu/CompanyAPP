@model List<CompanyAPP.Models.UserRolesViewModel>

@{
    ViewData["Title"] = "帳號管理";
}

@{
    var superAdmins = new List<string> { "admin@default.com" };
}


<div class="container mt-4">
    <h2> 系統帳號與權限管理</h2>
</div>


@* 顯示執行結果 *@
@if (TempData["StatusMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["StatusMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

    <div class="card shadow-sm mt-3">
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>帳號 (Email)</th>
                        <th>驗證狀態</th>
                        <th>目前身分 (Roles)</th>
                        <th class="text-center">操作</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Model)
                    {
                        <tr>
                            <td>@user.Email</td>

                        @* 驗證狀態 *@
                        <td>
                            @if (user.EmailConfirmed)
                            {
                                <span class="badge bg-success">已驗證</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">未驗證</span>
                            }

                            @* 單一開通按鈕 *@
                            <form asp-action="VerifyUser" method="post" style="display:inline;">
                                <input type="hidden" name="userId" value="@user.UserId" />
                                <button type="submit" class="btn btn-sm btn-outline-success py-0 px-2"
                                        title="手動協助開通"
                                        onclick="return confirm('確定要將 @user.Email 設為已驗證嗎？');">
                                    <small>開通</small>
                                </button>
                            </form>         
                        </td>

                        @* 目前身分*@
                        <td>
                            @foreach (var role in user.Roles)
                            {
                                <span class="badge bg-secondary">@role</span>
                            }
                        </td>

                        @* 操作功能 *@
                        <td class="text-center">
                            <div class="btn-group">
                                @if (superAdmins.Contains(user.Email))
                                {
                                    <span class="badge bg-secondary fst-italic">由系統保護</span>
                                }
                                else
                                {
                                    @* 跳轉到 ManageRoles 的按鈕 *@
                                    <a asp-action="ManageRoles" asp-route-userId="@user.UserId"
                                       class="btn btn-outline-primary btn-sm">
                                        分配權限
                                    </a>


                                    @* 刪除按鈕 *@
                                    @if (User.Identity.Name != user.Email)
                                    {
                                        <a asp-action="Delete" asp-route-id="@user.UserId"
                                           class="btn btn-outline-danger btn-sm ms-1"
                                           onclick="return confirm('確定要刪除此帳號？');">刪除</a>
                                    }
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>