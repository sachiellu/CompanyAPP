@model IEnumerable<CompanyAPP.Models.Employee>
@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager

@{
    ViewData["Title"] = "員工管理";

    // 獲取角色資訊
    bool isAdmin = User.IsInRole("Admin");
    bool isAdminOrManager = User.IsInRole("Admin") || User.IsInRole("Manager");
}

<div class="container mt-4">
    @* 標題與功能列 *@
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1> 員工管理</h1>
        <div>
            @* 批次刪除按鈕 (預設隱藏)(限 Admin) *@
            @if (isAdmin)
            {
                <button type="button" class="btn btn-danger me-2" onclick="submitBatchDelete()">
                    刪除選取項目
                </button>
			}
            @if (isAdminOrManager)
            {
                <a asp-action="Create" class="btn btn-primary me-2">
                    + 新增員工
                </a>
            }
        </div>
    </div>

    @* 搜尋框 *@
    <div class="input-group mb-4 shadow-sm">
        <span class="input-group-text bg-white border-end-0">🔍</span>
        <input type="text" id="searchInput" class="form-control border-start-0"
               placeholder="請輸入姓名、職位或 Email (即時搜尋)..."
               oninput="searchEmployees()">
    </div>

    @* 專門給 JavaScript 抓 Token 用的隱藏區塊 *@
    <div id="csrf-token-container" style="display:none;">
        @Html.AntiForgeryToken()
    </div>

    @* 表格容器 *@
    <div class="card shadow-sm">
        <div class="card-body p-0" id="tableContainer">
            <partial name="_EmployeeTable" model="Model" />
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // 1. 搜尋功能的防抖動機制
        let timeout = null;
        function searchEmployees() {
            let keyword = document.getElementById("searchInput").value;
            clearTimeout(timeout);
            timeout = setTimeout(function () 
            {
                let url = `/Employees/Filter?searchString=${keyword}`;
                $("#tableContainer").load(url, function(response, status, xhr) 
                {
                    if (status == "error") 
                    {
                        console.log("搜尋失敗");
                    }
                }
                );
            }, 300);
        }

            // 2. 全選 Checkbox 控制 
        function toggleSelectAll(source) { 
            let checkboxes = document.querySelectorAll('.row-checkbox');
            for (let i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = source.checked;
            }
        }

        // 3. 送出批次刪除 (進化版：解決表單巢狀衝突)
        function submitBatchDelete() {
            // 1. 抓取所有被打勾的 checkbox
            let checkedBoxes = document.querySelectorAll('.row-checkbox:checked');

            if (checkedBoxes.length === 0) {
                if(typeof Swal !== 'undefined') {
                    Swal.fire('提示', '請至少選擇一筆資料！', 'info');
                } else {
                    alert('請至少選擇一筆資料！');
                }
                return;
            }

            // 定義刪除邏輯
            let executeDelete = function() {
                // --- 核心魔法：動態建立一個表單 ---
                let form = document.createElement('form');
                form.method = 'POST';
                form.action = '/Employees/DeleteBatch';

                // 精準抓取剛剛埋在 #csrf-token-container 裡的 Token
                let tokenInput = document.querySelector('#csrf-token-container input[name="__RequestVerificationToken"]');

                if (tokenInput) {
                    form.appendChild(tokenInput.cloneNode(true));
                } else {
                    alert('錯誤：找不到資安驗證權杖 (Anti-Forgery Token)，請重新整理頁面。');
                    return; // 沒 Token 就不要送了，送了也是 400
                }

                // 把 ID 塞進去
                checkedBoxes.forEach(box => {
                    let input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'ids'; // 這要對應 Controller 的參數名稱
                    input.value = box.value;
                    form.appendChild(input);
                });

                document.body.appendChild(form);
                form.submit();
            };

            // 判斷是否使用 SweetAlert
            if(typeof Swal !== 'undefined') {
                Swal.fire({
                    title: '確定要刪除嗎?',
                    text: `即將刪除 ${checkedBoxes.length} 筆資料，此動作無法復原！`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: '是的，全部刪除!',
                    cancelButtonText: '取消'
                }).then((result) => {
                    if (result.isConfirmed) {
                        executeDelete();
                    }
                });
            } else {
                // 你的截圖顯示你目前是用原生的 confirm，也保留這個備案
                if (confirm(`確定要刪除這 ${checkedBoxes.length} 筆資料嗎？此動作無法復原！`)) {
                    executeDelete();
                }
            }
        }

    </script>
    }
 