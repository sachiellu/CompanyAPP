@model IEnumerable<CompanyAPP.Models.Employee>
@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager

@{
    ViewData["Title"] = "員工管理";
    // 獲取權限狀態
    bool isAdmin = User.IsInRole("Admin");
    bool isAdminOrManager = User.IsInRole("Admin") || User.IsInRole("Manager");
}

<div class="container mt-4">
    @* 標題與功能列 *@
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1> 員工管理</h1>

    <div class="d-flex gap-2">
        @* 1. 更多功能 (Excel 匯入/匯出) - 收納進下拉選單 *@
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-gear-fill"></i> 更多功能
            </button>
            <ul class="dropdown-menu">
                @* 匯出 (所有人可見) *@
                <li>
                    <a class="dropdown-item" asp-action="ExportToExcel">
                        <i class="bi bi-file-earmark-excel text-success"></i> 匯出 Excel 報表
                    </a>
                </li>

                @* 匯入 (限管理員) *@
                @if (isAdminOrManager)
                {
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item" asp-action="Import">
                            <i class="bi bi-upload text-primary"></i> 批次匯入資料
                        </a>
                    </li>
                }
            </ul>
        </div>

        @* 2. 刪除按鈕 (危險操作，獨立顯示) *@
        @if (isAdmin)
        {
            <button type="button" class="btn btn-outline-danger" onclick="submitBatchDelete()">
                <i class="bi bi-trash"></i> 刪除選取
            </button>
        }

        @* 3. 新增按鈕 (主要操作，最顯眼) *@
        @if (isAdminOrManager)
        {
            <a asp-action="Create" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> 新增員工
            </a>
        }
    </div>
</div>

    @* 搜尋框 *@
    <div class="input-group mb-4 shadow-sm">
        <span class="input-group-text bg-white border-end-0">🔍</span>
        <input type="text" id="searchInput" class="form-control border-start-0"
               placeholder="請輸入姓名、職位或 Email (即時搜尋)..."  
               oninput="searchEmployees()">
    </div>

    @* 專門給 JavaScript 抓 Token 用的隱藏區塊 *@
    <div id="csrf-token-container" style="display:none;">
        @Html.AntiForgeryToken()
    </div>

    @* 表格容器 *@
    <div class="card shadow-sm">
        <div class="card-body p-0" id="tableContainer">
            <partial name="_EmployeeTable" model="Model" />
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // 1. 搜尋功能的防抖動機制
        let timeout = null;
        function searchEmployees() {
            let keyword = document.getElementById("searchInput").value;
            clearTimeout(timeout);
            timeout = setTimeout(function () 
            {
                let url = `/Employees/Filter?searchString=${keyword}`;
                $("#tableContainer").load(url, function(response, status, xhr) 
                {
                    if (status == "error") 
                    {
                        console.log("搜尋失敗");
                    }
                }
                );
            }, 300);
        }

            // 2. 全選 Checkbox 控制 
        function toggleSelectAll(source) { 
            let checkboxes = document.querySelectorAll('.row-checkbox');
            for (let i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = source.checked;
            }
        }

        // 3. 送出批次刪除 (進化版：解決表單巢狀衝突)
        function submitBatchDelete() {
            // 1. 抓取所有被打勾的 checkbox
            let checkedBoxes = document.querySelectorAll('.row-checkbox:checked');

            if (checkedBoxes.length === 0) {
                if(typeof Swal !== 'undefined') {
                    Swal.fire('提示', '請至少選擇一筆資料！', 'info');
                } else {
                    alert('請至少選擇一筆資料！');
                }
                return;
            }

            // 定義刪除邏輯
            let executeDelete = function() {
                // --- 核心魔法：動態建立一個表單 ---
                let form = document.createElement('form');
                form.method = 'POST';
                form.action = '/Employees/DeleteBatch';

                // 精準抓取剛剛埋在 #csrf-token-container 裡的 Token
                let tokenInput = document.querySelector('#csrf-token-container input[name="__RequestVerificationToken"]');

                if (tokenInput) {
                    form.appendChild(tokenInput.cloneNode(true));
                } else {
                    alert('錯誤：找不到資安驗證權杖 (Anti-Forgery Token)，請重新整理頁面。');
                    return; // 沒 Token 就不要送了，送了也是 400
                }

                // 把 ID 塞進去
                checkedBoxes.forEach(box => {
                    let input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'ids'; // 這要對應 Controller 的參數名稱
                    input.value = box.value;
                    form.appendChild(input);
                });

                document.body.appendChild(form);
                form.submit();
            };

            // 判斷是否使用 SweetAlert
            if(typeof Swal !== 'undefined') {
                Swal.fire({
                    title: '確定要刪除嗎?',
                    text: `即將刪除 ${checkedBoxes.length} 筆資料，此動作無法復原！`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: '是的，全部刪除!',
                    cancelButtonText: '取消'
                }).then((result) => {
                    if (result.isConfirmed) {
                        executeDelete();
                    }
                });
            } else {
                // 你的截圖顯示你目前是用原生的 confirm，也保留這個備案
                if (confirm(`確定要刪除這 ${checkedBoxes.length} 筆資料嗎？此動作無法復原！`)) {
                    executeDelete();
                }
            }
        }

    </script>
    }
 