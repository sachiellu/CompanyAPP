name: .NET 9 CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    name: Build, Test and Analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 為了讓 SonarCloud 分析完整歷史，這裡要設為 0

      # 1. 安裝 Java (SonarScanner 需要)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu'

      # 2. 安裝 .NET
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      # 3. 安裝 SonarScanner 工具
      - name: Install SonarCloud scanner
        run: dotnet tool install --global dotnet-sonarscanner

      # 4. 開始分析 (Begin) + 編譯 + 測試 + 結束分析 (End)
      - name: Build and Analyze
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub 內建的，不用設
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}    # 你剛剛設的 Secret
        run: |
          dotnet sonarscanner begin /k:"sachiellu_CompanyAPP" /o:"sachiellu" /d:sonar.token="${{ secrets.SONAR_TOKEN }}" /d:sonar.host.url="https://sonarcloud.io" /d:sonar.cs.opencover.reportsPaths="**/TestResults/**/coverage.opencover.xml"

          dotnet restore
          dotnet build --no-restore --configuration Release
          
          # 執行測試
          dotnet test --no-build --configuration Release --verbosity normal --collect:"XPlat Code Coverage" -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
          
          # 結束分析 (這時候會把報告上傳到 SonarCloud)
          dotnet sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"


  # 第二階段：自動部署到 QA (CD)
  deploy-qa:
    needs: build-and-test  # 關鍵：一定要測試通過才部署
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' # 只在 push 到 main 時執行
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # 安裝 flyctl
      - uses: superfly/flyctl-actions/setup-flyctl@master
      
      # 執行部署指令 (指定部署到 QA)
      - name: Deploy to Fly.io (QA)
        working-directory: ./CompanyAPP
        run: flyctl deploy --remote-only -a companyapp-qa
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN_QA }}