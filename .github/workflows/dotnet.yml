name: .NET 9 CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # 第一階段：編譯與測試 (CI)
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration Release

    - name: Test
      # 這裡如果測試紅燈，流程就會直接中斷，不會往下跑部署
      run: dotnet test --no-build --configuration Release --verbosity normal


  # 第二階段：自動部署到 QA (CD)
  deploy-qa:
    needs: build-and-test  # 關鍵：一定要測試通過才部署
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' # 只在 push 到 main 時執行
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # 安裝 flyctl
      - uses: superfly/flyctl-actions/setup-flyctl@master
      
      # 執行部署指令 (指定部署到 QA)
      - name: Deploy to Fly.io (QA)
        run: flyctl deploy --remote-only -a companyapp-qa
        env:
          FLY_API_TOKEN: ${{ secrets.QA_FLY_API_TOKEN }}